---
title: "backup"
date: 2022-04-10T20:40:16+09:00
tags: ["linux"] 
author: "Me"
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowCodeCopyButtons: true
---

## バックアップの種類

完全バックアップ：全てのファイルを対象としてバックアップを行う。

差分バックアップ：前回のフルバックアップ以後に作成もしくは変更されたファイルをバックアップする。バックアップを復元するには、フルバックアップと最新の差分バックアップが必要となる。

増分バックアップ：前回行われたバックアップから変更/追加のあった箇所をバックアップする。一回あたりのバックアップ量を少なくできるが、復元時に複数のデータブロックを繋ぎ合わせるひつゆおがあるため、作業が煩雑になる。

## バックアップデバイス

- CD-R/RW：安価で広く利用されているが、量量が小さい(650MB~700MB)
- DVD-R/RW：一度だけ書き込みできるもの(DVD-R)と、追記/書き換えできるもの(DVDRW, DVD-RAM, DVD+R, DVD+RW)がある。容量は4.7GB~8.54GB
- BD-R/RE：繰り返し書き換えできる。容量は25GB~50GB
- 磁気テープ：大容量であり、比較的低価格。メディアの特性上テープが摩耗してしまわないうちに、定期的に新しいメディアに取り替える必要がある。
- ネットワーク：NASのようなネットワークに接続してすぐ使えるストレージも普及している。

## ローカルでのバックアップ

以下のコマンドがある。

### tarコマンド

### ddコマンド

入力側に指定したファイルの内容を、ファイルもしくは標準出力を送る。

```bash
# ハードディスク/dev/sdaを/dev/sdbにコピーする
$ dd if=/dev/sda of=/dev/sdb

# CD-ROMの内容をイメージファイルとして/tmp/cdrom.isoにコピーする
$ dd if=/dev/sr0 of=/tmp/cdrom.iso
```

### dumpコマンド

ファイルシステム単位でext2/ext3/ext4ファイルシステムをバックアップする。

バックアップからファイルを取り出すには`restore`コマンドを使う。

`dump`コマンドは磁気テープにバックアップを取る用途に適している。メデイアの容量が超えた場合、自動的に複数のメディアに分けて処理する。

|オプション|説明|
|-|-|
|`0~9`|dumpレベルを指定する|
|`u`|バックアップ実施時に/etc/dumpdatesファイルを更新する|
|`f デバイス名`|バックアップ装置のデバイスを指定する|

```bash
# dev/sdb1を/backup/sdb1.dumpにバックアップする
$ dump -f /backup/sdb1.dump /dev/sdb1

# 増分バックパップとは、前回実行したバックアップに対し、変更があった分だけを今回バックアップする処理。
# 増分バックアップはどの版に対するバックアップを取るのか指定するためにレベルを使う
# 初回はレベル0で全体バックアップし、次からは追加、変更があったファイルだけをバックアップする。

# 初回フルバックアップ
$ dump -0uf /backup/sdb1.dump /dev/sdb1
# 増分バックアップレベルの1, 初回から変更した分だけをバックアップする
$ dump -1uf /backup/sdb1.dump /dev/sdb1
# 増分バックアップレベルの2, 2より小さなレベルのバックアップから変化した分だけをバックアップする
$ dump -2uf /backup/sdb1.dump /dev/sdb1
```

### restoreコマンド

```bash
# -r:すべてのファイルを取り出す
# -f デバイス名:バックアップ装置のデバイスを指定する
$ restore rf /dev/st0
```


## ネットワーク経由でのバックアップ

`rsync`コマンドを使うと、ローカルホスト内のディレクトリ間だけでなくリモートホストとの間でもファイルのコピー、同期、差分だけコピーができる。

|オプション|説明|
|-|-|
|`-v`|コピー中のファイルを表示する|
|`-a`|アーカイブモード(ファイルやディレクトリの属性をそのままコピー)|
|`-r`|ディレクトリ内に再帰的にコピー|
|`-u`|変更・追加されたファイルのみコピーする|
|`-l`|シンボリックリンクをそのままコピーする|
|`-H`|ハードリンクをそのままコピーする|
|`-o`|所有者をそのまま維持する|
|`-g`|所有グループをそのまま維持する|
|`-n`|テスト|
|`-z`|ファイルを圧縮する|
|`--delete`|コピー元ファイル削除はコピー先でも削除する|

```bash
# ローカルホスト内でdirディレクトリを/backupディレクトリ内に差分コピーする
$ rsync -auv --delete dir /backup
# ローカルホスト内でdirディレクトリ内のファイルを/backupディレクトリ内に差分コピーする
$ rsync -auv --delete dir/ /backup
# dirディレクトリを、host120の/backupディレクトリ内に差分コピーする
# リモートホストへのバックアップ：ユーザ名＠ホスト名:パス
$ rsync -auvz --delete -e ssh dir host120:backup
```
