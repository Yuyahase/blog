---
title: "システム起動プロセス"
date: 2022-04-14T19:28:50+09:00
tags: ["linux"] 
author: "Me"
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowCodeCopyButtons: true
---

## ブートからカーネルの起動まで

### BIOS

電源が投入されると、不揮発性メモリに格納されているBIOSが実行され、以下を実施する。

- メモリのチェック
- ハードウェア設定の読み込み
- 起動デバイスのチェック
- 起動デバイスのマスターブートレコード内に格納されたブートローダを実行

### UEFI

旧来のBIOSの代替となるOSとファームウェア間のインターフェース規格がUEFI。

起動ドライブの容量制限(2TB)がなくなり、GUIベースのセットアップ画面が利用できるなど、さまざまな拡張が行われている。

FAT16またはFAT32でフォーマットされている必要がある。

### MBR/GPT

### カーネル

- 組み込まれているハードウェアの検出
- メモリの初期化
- システムクロックの設定
- IRQの設定
- ルートパーティションのマウント
- initプログラムを実行

## SysVinitの概要

UNIX系OS全般で広く使われてきた`SysVinit`が主流だったが、現在ではsystemdという起動の仕組みが主流。

`/etc/inittab`の書式は以下の通り。

```bash
# ID:エントリを識別するためのID(1~4文字)を指定
# ランレベル:そのエントリが処理を行うランレベルを指定
# アクション指示子:どのようなタイミングで処理を行うのかを指定
# 処理:initが実行するプロセスを指定
2:2345:respawn:/sbin/mingetty tty2
```

アクション指示子は以下の通り。

|アクション指示子|説明|
|-|-|
|`boot`|システム起動時に実行され、プロセスの終了を待たずに次の処理を行う|
|`bootwait`|システム起動時に実行され、プロセスの終了するまで次の処理を行わない|
|`respawn`|プロセスが終了しても自動的に再起動する|
|`once`|指定したランレベルになったときに一度実行され、プロセスの終了を待たずに次の処理を行う|
|`sysinit`|システム起動時に実行され、プロセスの終了するまで次の処理を行わない|
|`wait`|システム起動時に実行され、プロセスの終了するまで次の処理を行わない|

## 起動スクリプトとランレベル

通常、起動されるサービスはランレベルごとに異なる。

ランレベルごとにどのようなサービスが用意されているかは、`/etc/rc[0-6].d`ディレクトリを見るとわかる。

ファイル名が`S`から始まるものが、このランレベルで起動するサービス。

ファイル名が`K`から始まるものが、このランレベルで終了するサービス。

`K`->`S`の順で実行される。

## サービスの自動起動

ランレベルごとにどのサービスをデフォルトで起動するかは、いくつかの方法で設定できる。

### 手動でリンクを作成

`/etc/rc[0-6].d`ディレクトリ以下のファイル名が`S`で始まるもの。

自動起動させたいサービスの起動スクリプトのシンボリックリンクを作成すればよい。

```bash
ln -s /etc/init.d/httpd /etc/rc3.d/S86httpd
```

### chkconfigコマンド

RedHat系では`chkconfig`コマンドを利用する。

```bash
# httpdが自動起動しないようにする
$ chkconfig httpd off
# httpdサービスがランレベル2,3,5でhttpdサービスが起動するようにする
$ chkconfig httpd on
$ chkconfig --level 235 httpd on
```

### update-rc.dコマンド

Debian系では`update-rc.d`コマンドを利用する。

|オプション・引数|説明|
|`-n`|表示するだけで何もしない|
|`remove`|起動スクリプトのシンボリックリンクを削除する|
|`defaults`|デフォルトのスクリプトを作成する|
|`start`|起動用のスクリプトを作成する|
|`stop`|停止用のスクリプトを作成する|

```bash
# ランレベル1,2,4で優先度25でリンクを作る
$ update-rc.d sshd stop 25 1 2 4 .
```

## systemdの概要

systemdを使ったシステムにおいて、ユニット、ターゲットの定義ファイルを配置するディレクトリは、以下がある。

|ディレクトリ|説明|
|`/usr/lib/systemd/system`|永続的なユニット・ターゲットの定義ファイルが置かれるディレクトリ|
|`/etc/systemd/system`|カスタム用ディレクトリ`/usr/lib/systemd/system`や`/run/systemd/system`より優先度が高い|
|`/run/systemd/system`|再起動されると削除されるディレクトリ`/usr/lib/systemd/system`より優先度が高いが、`/etc/systemd/system`より優先しない|

systemdではUnitという単位で各種処理が進められる。

|種類|説明|
|-|-|
|`service`|各種サービスを起動・停止する|
|`mount`|ファイルシステムをマウント(/etc/fstabにより自動生成)|
|`device`|udevによって認識されたデバイス|
|`target`|ユニットをグループ化|

## systemdの起動手順

systemdでは、システム起動する際、デフォルトでは`default.target`というターゲットが起動される。

systemctlコマンドで、システム全体の起動/停止に関わるサブコマンドは以下の通り。

|サブコマンド|説明|
|-|-|
|`poweroff`|電源OFF|
|`emergency`|緊急モードに移行|
|`rescue`|レスキューモードに移行|
|`default`|標準のモードに移行|
|`reboot`|再起動|

`rescueモード`はSysVinitにおけるシングルユーザモードに該当するが、`emerjencyモード`はより最小限の環境を提供し、`rescueモード`でも起動できないような時にシステムの修復を試みるためのモード。

## ブートローダ

ブートローダにカーネルをロードさせる際に、起動オプションを指定することができる。

プロンプトはGRUB Legacyの場合`kernel`、GRUB2の`linux`

|起動オプション|説明|
|-|-|
|`init=PATH`|initの代わりに指定コマンドを実行|
|`数字(0-6)`|指定したランレベルで起動|
|`single`|シングルユーザモードで起動|
|`nosmp | maxcpus=0`|マルチプロセッサマシンをシングルプロセッサマシンとして動作させる|

`nosmp`または`maxcpus=0`は`SMP(Symmetric Multiple Processor)`モードを無効にする。

### GRUB

多くのディストリビューションで標準的に使用されているブートローダ。

設定ファイルは、`/boot/grub/menu.lst`や`/etc/grub.conf`等。

多数のファイルシステムを認識可能。

シェル機能を搭載し、コマンドによる高度な管理が可能。

カーネルイメージが格納されているパーティションを指定するには、`root (hdディスク番号, パーティション番号)`のように指定する。番号はどちらも0から数える。

GRUBには古くから使われてきたGRUB Legacyと、新たに設計し直されたGRUB2がある。

### GRUB2

設定は`/etc/default/grub`ファイルで行い、`grub-mkconfig`コマンドで`grub.cfg`ファイルを生成する。

## その他のブートローダ

|コンポーネント説明|説明|
|-|-|
|`SYSLINUX`|FATファイルシステムからカーネルを起動するプログラム|
|`ISOLINUX`|ISO9660ファイルシステム(CD-ROM)からカーネルを起動するプログラム|
|`EXTLINUX`|ext2/ext3/ext4ファイルシステムからカーネルを起動するプログラム|
|`PXELINUX`|PXEを使ってネットワークブートをするプログラム|

PXEブート(Preboot Execution Enviroment)は、Intel社によって策定されたネットワークブートの規格。

DHCPやBOOTPを使ってネットワーク情報を取得し、TFTPでブートプログラムをダウンロードで起動する。

PXEブートサーバ側では、DHCPおよびTFTPサーバが稼働している必要がある。

PXEクライアント側では、PXE準拠のネットワークインターフェースが必要。

U-bootはオープンソースの組み込み用ブートローダ。サイズ制約に対応するため分割されたステージに分けられる仕様となっている。

`shim.efi`は、セキュアブート時に最初に読み込まれるUEFIアプリケーション。X.509証明書を使って、署名の識別を行う。

`grubx64.efi`はUEFIを使ったシステムにおいて、grubを起動するUEFIアプリケーション。
