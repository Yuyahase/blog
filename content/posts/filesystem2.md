---
title: "ファイルシステム"
date: 2022-04-14T19:28:50+09:00
tags: ["linux"] 
author: "Me"
ShowReadingTime: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowCodeCopyButtons: true
---

#

現在サポートしているファイルシステムの種類一覧を得る方法は`/proc/filesystems`

S.M.A.R.T(Self-Monitoring, Analysis and Reporting Technology System)は、ハードディスクの問題を発見する自己診断ツール。

LinuxにはS.M.A.R.Tの情報を取得する`smartmontools`というソフトウェアがある。

`smartmontools`は`smartdデーモン`で、S.M.A.R.Tを定期的に監視する。

監視内容は`smartctl`コマンドで確認できる。

|オプション|説明|
|`-a | --all`|全てのS.M.A.R.T情報を表示|
|`-i | --info`|S.M.A.R.Tの対応状況やデバイスの情報を表示|
|`-c | --capabilities`|テストの対応状況を表示|
|`-t |--test`|自己診断テストの実行|
|`-l | --log`|テストログの表示|
|`-H | --health`|デバイスの健康状態を表示|
|`--scan`|認識されているデバイスの表示|

ZFSを参考して開発されてスナップショットなどの機能を持つのは`btrfs`という。

`btrfs`コマンド

|オプション|説明|
|`subvolume show`|ファイルシステムの情報を表示|
|`subvolume create`|サブボリュームを作成|
|`subvolume delete`|サブボリュームを削除|
|`subvolume list`|サブボリュームの一覧を表示|
|`subvolume snapshot`|スナップショットを作成|

## スワップ

`swapon -s`でシステムで有効になっているスワップ領域の利用状況を調べる。

`cat /proc/swaps`を参照すると、スワップ領域の利用状況を表示できる。

## ファイルシステムの作成

### ext2/ext3/ext4ファイルシステムの作成

ext2/ext3ファイルシステムはブロック単位で管理される。

ブロックには以下がある。

- データ部録
- iノードブロック
- スーパーブロック

データブロックにはファイルの内容が格納され、ブロックグループという単位で纏められる。

どのデータブロックにどんなデータが格納されているかは、`iノード`に記録される。

スーパーブロックには、ファイルシステムの全般的な情報が格納されている。

ext2/ext3/ext4ファイルシステムを作成するには、`mke2fs`コマンドを使う。

mke2fsコマンドのデフォルト値は、`/etc/mke2fs.conf`で設定できる。

mke2fsコマンドの主なオプション以下。

|オプション|説明|
|-|-|
|`-b サイズ`|ブロックサイズをバイト単位で指定する|
|`-c`|ファイルシステム作成前に不良ブロックのチェックを行う|
|`-i サイズ`|iノードあたりのバイト数を指定する|
|`-j`|ext3ファイスシステムを作成する|
|`-m 領域%`|rootユーザ用の予約領域を指定する|
|`-t タイプ`|ファイルシステムの種類を指定する(ext2, ext3, ext4)|

#### ext4ファイルシステムの作成

ext3ファイルシステムを拡張したファイルシステムがext4。

ext4ファイルシステムを作成するには、`mkfs.ext4`コマンドを使う。

```bash
# /dev/sdb1にext4ファイルシステムを作成する。
$ mkfs.ext4 /dev/sdb1

$ tune2fs -O extent, uninit_bg, dir_index /dev/sda5
```

#### Btrfsファイルシステムの作成

最大ファイルサイズは16EiB
コピーオンライト
ディスク容量の効率的な利用

`mkfs.btrfs`コマンドを実行します。

```bash
mkfs.btrfs /dev/sdb1 /dev/sdb2
```

#### CD/DVDの作成

CD-ROMなどに用いられる標準のフォーマットは`ISO9660`である。

`mkisofsコマンド`を使って作成する。

Joilet形式とはISO9660形式のファイル名制限などを緩和するために、独自に拡張を施した規格。

|オプション|説明|
|-|-|
|`-b`|ブータブルCDにする|
|`-o ファイル名`|イメージファイル出力先を指定する|
|`-R`|UNIX系拡張であるJoiletフォーマットで作成|
|`-udf`|DVDで用いられるUDFフォーマットで作成|

```bash
# ISO9660イメージを/tmp/etc.isoというファイル名で作成する
$ mkiosfs -o /tmp/etc.iso /etc


```

#### 暗号化ファイルシステムの作成

`cryptsetup`コマンドを使う。

```bash
# 暗号化ファイルシステムに付ける任意の名前を指定する。
$ cryptsetup create secret /dev/sdb1
Enter passphrase: # パスフレーズ設定

# すると/dev/mapperディレクトリ以下に、指定したデバイスファイルが作成される

# このデバイスファイルに対し任意のファイルシステムを作成する。
$ mkfs.ext4 /dev/mapper/secret
```

#### LUKS(Linux Unified Key Setup)

Linuxにおいて標準的に仕様される暗号化ファイルシステム。

LUKSを仕様する場合のcryptsetupコマンドは以下の通り。

|アクション|説明|
|-|-|
|`luksFormat デバイス名`|指定したデバイスをLUKSパーティションとして初期化|
|`luksOpen デバイス名 パーティション名`|デバイスとLUKSパーティション名を指定し、パーティションを開く|
|`luksDump デバイス名`|指定したデバイスの暗号化の状態を表示|

## ファイルシステムのチェック

ファイルシステムの整合性をチェックするには`fsck`コマンドを使う。

|オプション|説明|
|-|-|
|`-r`|対話的に修復を実行する|
|`-t`|ファイルシステムの種類を指定する|
|`-A`|`/etc/fstab`に記述されている全ファイルシステムに対して実行する|
|`-N`|実際には実行せず、実行するとどうなるかのみ表示する|

Linux起動時にもファイルシステムチェックが実行されるには、`/etc/fstab`でfsckの対象と指定するチェックが必要。

マウント中のファイルシステムはチェックできない。`shutdown -f`で次回起動時にチェックを実施する。

## オートマウント

CD-ROMやDVD-ROM、NFSディレクトリなど、必要なときだけマウントして利用するファイルシステムがある。

`autofsサービス`による`オートマウント`を利用すれば、自動的にマウントを行うことができる。

```bash
# autofsサービスの起動
$ systemctl start autofs
```

オートマウント設定には2種類のファイルが必要

- 全体的な設定を行う`/etc/auto.master`
- ファイルシステムごとに設定を行う`マップファイル`

### /etc/auto.master

書式
`マウントベース マップファイル オプション`

マウントベースが`/mnt/auto`の場合、オートマウントが実行されると、`/mnt/auto/dvdrom`というマウントポイントが自動的に作成される。

マウントオプションでは、ファイルシステムの種類や読み取り専用等の設定を行う。(必須でない)

デバイスファイル名は`:`で区切ったデバイスファイル名を指定する。
